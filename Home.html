<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>45度格線座位安排 - 熊窩地圖 (縮放版)</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #2c3e50;
            font-family: 'Courier New', monospace;
            color: #ecf0f1;
            overflow: auto;
        }
        
        .controls {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            margin: 0;
            padding: 10px;
            background: rgba(52, 73, 94, 0.95);
            backdrop-filter: blur(5px);
            border-radius: 0;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            border-bottom: 1px solid rgba(127, 140, 141, 0.3);
        }
        
        .controls input {
            padding: 5px;
            background: #2c3e50;
            border: 1px solid #7f8c8d;
            color: #ecf0f1;
            border-radius: 3px;
        }
        
        .controls button {
            padding: 5px 10px;
            background: #27ae60;
            border: none;
            color: white;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .controls button:hover {
            background: #2ecc71;
        }
        
        .controls button.debug {
            background: #f39c12;
        }
        
        .controls button.debug:hover {
            background: #e67e22;
        }
        
        .info {
            margin-left: auto;
            font-size: 12px;
            color: #95a5a6;
        }
        
        .map-container {
            position: relative;
            width: 10000px;
            height: 8000px;
            margin: 0;
            background: #34495e;
            border: none;
            cursor: crosshair;
            overflow: visible;
            transition: transform 0.3s ease;
        }
        
        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .grid-point {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #e74c3c;
            border-radius: 50%;
            pointer-events: none;
            z-index: 2;
            opacity: 0.7;
            border: 1px solid #ffffff;
        }
        
        .grid-point.major {
            width: 8px;
            height: 8px;
            background: #f39c12;
            opacity: 0.9;
        }
        
        .person {
            position: absolute;
            color: #2ecc71;
            font-size: 10px;
            white-space: nowrap;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
            cursor: move;
            border-radius: 3px;
            background: rgba(46, 204, 113, 0.2);
            border: 2px solid #2ecc71;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: bold;
            z-index: 10;
            transform: rotate(45deg);
            box-sizing: border-box;
        }
        
        .person .text {
            transform: rotate(-45deg);
        }
        
        .person:hover {
            background: rgba(52, 152, 219, 0.3);
            border-color: #3498db;
        }
        
        .person.dragging {
            background: rgba(231, 76, 60, 0.5);
            border-color: #e74c3c;
            z-index: 1000;
        }
        
        .person.green {
            background: rgba(46, 204, 113, 0.2);
            border-color: #2ecc71;
            color: #2ecc71;
        }
        
        .person.blue {
            background: rgba(52, 152, 219, 0.2);
            border-color: #3498db;
            color: #3498db;
        }
        
        .person.purple {
            background: rgba(155, 89, 182, 0.2);
            border-color: #9b59b6;
            color: #9b59b6;
        }
        
        .person.orange {
            background: rgba(230, 126, 34, 0.2);
            border-color: #e67e22;
            color: #e67e22;
        }
        
        .person.pink {
            background: rgba(233, 30, 99, 0.2);
            border-color: #e91e63;
            color: #e91e63;
        }
        
        .person.yellow {
            background: rgba(241, 196, 15, 0.2);
            border-color: #f1c40f;
            color: #f1c40f;
        }
        
        .person.cyan {
            background: rgba(26, 188, 156, 0.2);
            border-color: #1abc9c;
            color: #1abc9c;
        }
        
        .person.red {
            background: rgba(231, 76, 60, 0.2);
            border-color: #e74c3c;
            color: #e74c3c;
        }
        
        .coordinate-axis {
            position: fixed;
            bottom: 60px;
            right: 10px;
            color: #95a5a6;
            pointer-events: none;
            z-index: 5;
        }
        
        .axis-line {
            position: absolute;
            background: #95a5a6;
        }
        
        .h-line { width: 30px; height: 1px; top: 15px; }
        .v-line { width: 1px; height: 30px; left: 15px; }
        
        .coords {
            position: fixed;
            bottom: 5px;
            left: 5px;
            font-size: 10px;
            color: #7f8c8d;
            pointer-events: none;
            z-index: 5;
            background: rgba(44, 62, 80, 0.8);
            padding: 5px;
            border-radius: 3px;
        }
        
        .grid-info {
            position: fixed;
            top: 60px;
            left: 5px;
            font-size: 10px;
            color: #95a5a6;
            pointer-events: none;
            z-index: 5;
            background: rgba(44, 62, 80, 0.8);
            padding: 5px;
            border-radius: 3px;
        }
        
        .delete-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 16px;
            height: 16px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 10px;
            cursor: pointer;
            display: none;
            z-index: 15;
        }
        
        .person:hover .delete-btn {
            display: block;
        }
    </style>
</head>
<body>
    <div class="controls">
        <input type="text" id="newItemName" placeholder="輸入名稱" />
        <select id="itemType">
            <option value="person">成員 (2×2=4格)</option>
            <option value="small">小建築 (1×1=1格)</option>
            <option value="center">中心建築 (3×3=9格)</option>
            <option value="large">大建築 (4×4=16格)</option>
        </select>
        <select id="itemColor">
            <option value="green">綠色 (預設)</option>
            <option value="blue">藍色</option>
            <option value="purple">紫色</option>
            <option value="orange">橘色</option>
            <option value="pink">粉色</option>
            <option value="yellow">黃色</option>
            <option value="cyan">青色</option>
            <option value="red">紅色</option>
        </select>
        <button onclick="addItem()">新增項目</button>
        <button onclick="saveLayout()">儲存佈局</button>
        <button onclick="loadLayout()">載入佈局</button>
        <button onclick="exportLayout()">匯出座位表</button>
        <button onclick="clearAll()">清空所有</button>
        <button onclick="toggleDebugMode()" class="debug" id="debugBtn">顯示格點</button>
        <button onclick="zoomIn()" class="debug">放大 (+)</button>
        <button onclick="zoomOut()" class="debug">縮小 (-)</button>
        <button onclick="resetZoom()" class="debug">重置縮放</button>
        <div class="info">
            無邊際空間 + 縮放功能 | 右鍵改變顏色 | 縮放: <span id="zoomLevel">100%</span> | 目前項目: <span id="peopleCount">0</span>/100
        </div>
    </div>
    
    <div class="map-container" id="mapContainer">
        <div class="grid-overlay" id="gridOverlay"></div>
        
        <div class="coordinate-axis">
            <div class="axis-line h-line"></div>
            <div class="axis-line v-line"></div>
        </div>
        
        <div class="coords" id="coords">座標: 0, 0</div>
        <div class="grid-info">√2補償方案 | 格點間距:40px | 縮放: +/- 鍵 或 Ctrl+滾輪</div>
    </div>

    <script>
        const GRID_SIZE = 40;
        const MAP_WIDTH = 10000;
        const MAP_HEIGHT = 8000;
        const GRID_ORIGIN_X = MAP_WIDTH / 2;
        const GRID_ORIGIN_Y = MAP_HEIGHT / 2;
        
        let people = [
            {name: '熊窩', gridX: 0, gridY: 0, type: 'center'},
            {name: '急先鋒', gridX: 0, gridY: -5, type: 'person'},
            {name: 'Patato Q', gridX: 4, gridY: -2, type: 'person'},
            {name: 'Potato Sue', gridX: 5, gridY: 0, type: 'person'},
            {name: '阿基', gridX: 4, gridY: 4, type: 'person'},
            {name: 'Joeeeeeey', gridX: 0, gridY: 5, type: 'person'},
            {name: 'Joey2', gridX: -4, gridY: 4, type: 'person'},
            {name: '蝙蝠俠', gridX: -5, gridY: 0, type: 'person'},
            {name: 'Potato Justin', gridX: -4, gridY: -2, type: 'person'},
            {name: '黃禾', gridX: 0, gridY: -2, type: 'person'},
            {name: 'Potato Fish ovo', gridX: 3, gridY: 1, type: 'person'},
            {name: 'Potato Joey', gridX: -3, gridY: 1, type: 'person'},
            {name: 'Joey3', gridX: 0, gridY: 3, type: 'person'}
        ];
        
        let isDragging = false;
        let dragPerson = null;
        let dragOffset = {x: 0, y: 0};
        let debugMode = false;
        let zoomLevel = 1.0;
        
        function gridToPixel(gridX, gridY) {
            const gridStep = 40;
            const rotatedX = (gridX - gridY) * gridStep / 2;
            const rotatedY = (gridX + gridY) * gridStep / 2;
            
            return {
                x: GRID_ORIGIN_X + rotatedX,
                y: GRID_ORIGIN_Y + rotatedY
            };
        }
        
        function pixelToGrid(pixelX, pixelY) {
            const deltaX = pixelX - GRID_ORIGIN_X;
            const deltaY = pixelY - GRID_ORIGIN_Y;
            const gridStep = 40;
            
            const gridX = Math.round((deltaX + deltaY) / gridStep);
            const gridY = Math.round((deltaY - deltaX) / gridStep);
            
            return {gridX, gridY};
        }
        
        function renderPeople() {
            const container = document.getElementById('mapContainer');
            
            const existingPeople = container.querySelectorAll('.person');
            existingPeople.forEach(p => p.remove());
            
            document.getElementById('peopleCount').textContent = people.length;
            
            people.forEach((item, index) => {
                const div = document.createElement('div');
                // 添加顏色類別
                div.className = `person ${item.color || 'green'}`;
                div.dataset.index = index;
                
                const textDiv = document.createElement('div');
                textDiv.className = 'text';
                textDiv.textContent = item.name;
                div.appendChild(textDiv);
                
                const gridSpacing = 40;
                let size;
                
                switch(item.type) {
                    case 'small':
                        size = gridSpacing * Math.sqrt(2);
                        break;
                    case 'person':
                        size = gridSpacing * 2 * Math.sqrt(2);
                        break;
                    case 'center':
                        size = gridSpacing * 3 * Math.sqrt(2);
                        break;
                    case 'large':
                        size = gridSpacing * 4 * Math.sqrt(2);
                        break;
                    default:
                        size = gridSpacing * 2 * Math.sqrt(2);
                }
                
                const centerPos = gridToPixel(item.gridX, item.gridY);
                
                div.style.width = size + 'px';
                div.style.height = size + 'px';
                div.style.left = (centerPos.x - size/2) + 'px';
                div.style.top = (centerPos.y - size/2) + 'px';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = '×';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteItem(index);
                };
                div.appendChild(deleteBtn);
                
                // 右鍵點擊改變顏色
                div.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    changeColor(index);
                });
                
                div.addEventListener('mousedown', startDrag);
                container.appendChild(div);
            });
            
            saveToLocalStorage();
        }
        

        
        // 縮放功能 - 正確以視窗中心為縮放中心
        function applyZoom() {
            const container = document.getElementById('mapContainer');
            
            // 計算視窗中心點相對於容器的位置
            const containerRect = container.getBoundingClientRect();
            const viewportCenterX = window.innerWidth / 2;
            const viewportCenterY = window.innerHeight / 2;
            
            // 轉換為相對於容器的座標
            const containerCenterX = (viewportCenterX - containerRect.left) / zoomLevel;
            const containerCenterY = (viewportCenterY - containerRect.top) / zoomLevel;
            
            // 設置縮放中心點為當前視窗中心
            container.style.transformOrigin = `${containerCenterX}px ${containerCenterY}px`;
            container.style.transform = `scale(${zoomLevel})`;
            
            document.getElementById('zoomLevel').textContent = Math.round(zoomLevel * 100) + '%';
        }
        
        function zoomIn() {
            if (zoomLevel < 3.0) {
                zoomLevel *= 1.2;
                applyZoom();
            }
        }
        
        function zoomOut() {
            if (zoomLevel > 0.1) {
                zoomLevel /= 1.2;
                applyZoom();
            }
        }
        
        function resetZoom() {
            zoomLevel = 1.0;
            applyZoom();
        }
        
        function startDrag(e) {
            if (e.target.classList.contains('delete-btn')) return;
            
            isDragging = true;
            dragPerson = parseInt(e.target.closest('.person').dataset.index);
            
            const rect = e.target.closest('.person').getBoundingClientRect();
            dragOffset.x = e.clientX - (rect.left + rect.width/2);
            dragOffset.y = e.clientY - (rect.top + rect.height/2);
            
            e.target.closest('.person').classList.add('dragging');
            e.preventDefault();
            e.stopPropagation();
        }
        
        function addItem() {
            const nameInput = document.getElementById('newItemName');
            const typeSelect = document.getElementById('itemType');
            const name = nameInput.value.trim();
            const type = typeSelect.value;
            
            if (name) {
                people.push({
                    name: name,
                    gridX: 6,
                    gridY: 6,
                    type: type
                });
                nameInput.value = '';
                renderPeople();
            }
        }
        
        function deleteItem(index) {
            if (people[index].type === 'center' && people[index].name === '熊窩') {
                alert('中心建築（熊窩）不能刪除！');
                return;
            }
            people.splice(index, 1);
            renderPeople();
        }
        
        function exportLayout() {
            const layout = people.map(p => {
                const typeNames = {
                    'small': '小建築(1×1=1格)',
                    'person': '成員(2×2=4格)', 
                    'center': '中心建築(3×3=9格)',
                    'large': '大建築(4×4=16格)'
                };
                return `${p.name}: ${typeNames[p.type]} 格線(${p.gridX}, ${p.gridY})`;
            }).join('\n');
            const blob = new Blob([layout], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = '座位安排_格線座標.txt';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function saveToLocalStorage() {
            try {
                const data = JSON.stringify(people);
                localStorage.setItem('bearDenLayout', data);
            } catch (e) {
                console.warn('無法自動儲存:', e);
            }
        }
        
        function loadFromLocalStorage() {
            try {
                const data = localStorage.getItem('bearDenLayout');
                if (data) {
                    const loadedPeople = JSON.parse(data);
                    if (Array.isArray(loadedPeople) && loadedPeople.length > 0) {
                        people = loadedPeople;
                        return true;
                    }
                }
            } catch (e) {
                console.warn('載入儲存資料失敗:', e);
            }
            return false;
        }
        
        function saveLayout() {
            try {
                const data = JSON.stringify(people, null, 2);
                const blob = new Blob([data], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = '熊窩座位佈局.json';
                a.click();
                URL.revokeObjectURL(url);
                alert('佈局已儲存！');
            } catch (e) {
                alert('儲存失敗: ' + e.message);
            }
        }
        
        function loadLayout() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const loadedPeople = JSON.parse(e.target.result);
                            if (Array.isArray(loadedPeople)) {
                                people = loadedPeople;
                                renderPeople();
                                alert('佈局載入成功！');
                            } else {
                                alert('檔案格式錯誤！');
                            }
                        } catch (err) {
                            alert('載入失敗: ' + err.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
        
        function clearAll() {
            if (confirm('確定要清空所有項目嗎？（熊窩會保留）')) {
                people = people.filter(p => p.type === 'center' && p.name === '熊窩');
                renderPeople();
            }
        }
        
        // 滑鼠事件
        document.addEventListener('mousemove', (e) => {
            const container = document.getElementById('mapContainer');
            const rect = container.getBoundingClientRect();
            const pixelX = e.clientX - rect.left;
            const pixelY = e.clientY - rect.top;
            const grid = pixelToGrid(pixelX, pixelY);
            
            document.getElementById('coords').textContent = 
                `座標: ${Math.round(pixelX)}, ${Math.round(pixelY)} | 格線: (${grid.gridX}, ${grid.gridY})`;
            
            if (isDragging && dragPerson !== null) {
                const newPixelX = e.clientX - rect.left - dragOffset.x;
                const newPixelY = e.clientY - rect.top - dragOffset.y;
                const newGrid = pixelToGrid(newPixelX, newPixelY);
                
                people[dragPerson].gridX = newGrid.gridX;
                people[dragPerson].gridY = newGrid.gridY;
                
                renderPeople();
            }
        });
        
        document.addEventListener('mouseup', () => {
            if (isDragging) {
                setTimeout(() => {
                    isDragging = false;
                    dragPerson = null;
                    document.querySelectorAll('.person').forEach(p => p.classList.remove('dragging'));
                }, 10);
            }
        });
        
        document.getElementById('mapContainer').addEventListener('click', (e) => {
            if (isDragging) return;
            
            if ((e.target.id === 'mapContainer' || e.target.id === 'gridOverlay')) {
                const rect = e.currentTarget.getBoundingClientRect();
                const pixelX = e.clientX - rect.left;
                const pixelY = e.clientY - rect.top;
                const grid = pixelToGrid(pixelX, pixelY);
                
                const name = prompt('輸入項目名稱：');
                if (name && name.trim()) {
                    const type = prompt('選擇類型：\n1 = 小建築(1×1)\n2 = 成員(2×2)\n3 = 中心建築(3×3)\n4 = 大建築(4×4)\n\n請輸入數字 1-4：');
                    const typeMap = {
                        '1': 'small',
                        '2': 'person', 
                        '3': 'center',
                        '4': 'large'
                    };
                    
                    const selectedType = typeMap[type] || 'person';
                    
                    people.push({
                        name: name.trim(),
                        gridX: grid.gridX,
                        gridY: grid.gridY,
                        type: selectedType
                    });
                    renderPeople();
                }
            }
        });
        
        // 鍵盤快捷鍵
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && document.getElementById('newItemName') === document.activeElement) {
                addItem();
            }
            else if (e.key === '=' || e.key === '+') {
                e.preventDefault();
                zoomIn();
            }
            else if (e.key === '-' || e.key === '_') {
                e.preventDefault();
                zoomOut();
            }
            else if (e.key === '0' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                resetZoom();
            }
        });
        
        // 滑鼠滾輪縮放
        document.getElementById('mapContainer').addEventListener('wheel', (e) => {
            if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                if (e.deltaY < 0) {
                    zoomIn();
                } else {
                    zoomOut();
                }
            }
        });
        
        // 初始化 - 把所有物件移到中心方便測試
        function initialize() {
            const loaded = loadFromLocalStorage();
            
            // 如果沒有從本地儲存載入，就把預設物件移到中心
            if (!loaded) {
                // 重新安排物件位置，集中在中心區域
                people = [
                    {name: '熊窩', gridX: 0, gridY: 0, type: 'center'},
                    {name: '急先鋒', gridX: 0, gridY: -3, type: 'person'},
                    {name: 'Patato Q', gridX: 3, gridY: -1, type: 'person'},
                    {name: 'Potato Sue', gridX: 3, gridY: 1, type: 'person'},
                    {name: '阿基', gridX: 3, gridY: 3, type: 'person'},
                    {name: 'Joeeeeeey', gridX: 0, gridY: 3, type: 'person'},
                    {name: 'Joey2', gridX: -3, gridY: 3, type: 'person'},
                    {name: '蝙蝠俠', gridX: -3, gridY: 1, type: 'person'},
                    {name: 'Potato Justin', gridX: -3, gridY: -1, type: 'person'},
                    {name: '黃禾', gridX: 0, gridY: -1, type: 'person'},
                    {name: 'Potato Fish ovo', gridX: 2, gridY: 0, type: 'person'},
                    {name: 'Potato Joey', gridX: -2, gridY: 0, type: 'person'},
                    {name: 'Joey3', gridX: 0, gridY: 2, type: 'person'}
                ];
            }
            
            renderPeople();
            applyZoom();
            
            // 滾動到地圖中心，讓所有物件都在視野中
            const centerX = MAP_WIDTH / 2 - window.innerWidth / 2;
            const centerY = MAP_HEIGHT / 2 - window.innerHeight / 2;
            
            window.scrollTo(centerX, centerY);
        }
        
        window.addEventListener('resize', () => {
            renderPeople();
        });
        
        initialize();
    </script>
</body>
</html>